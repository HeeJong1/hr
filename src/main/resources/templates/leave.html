<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ì°¨ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/leave.css">
</head>

<body class="leavePage">
    <section class="layoutSection">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
        <button class="menuToggle" onclick="toggleSidebar()">â˜°</button>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebarHeader">
                <h2>HR ì‹œìŠ¤í…œ</h2>
            </div>
            <nav class="sidebarMenu">
                <a href="/home" class="menuItem">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="/notice" class="menuItem">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                <a href="/leave" class="menuItem active">ğŸ“… ì—°ì°¨ê´€ë¦¬</a>
                <a href="/leaveCalendar" class="menuItem">ğŸ—“ï¸ íœ´ê°€ìº˜ë¦°ë”</a>
                <a href="/attendance" class="menuItem">â° ì¶œí‡´ê·¼</a>
                <a href="/salary" class="menuItem">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</a>
                <a href="/employee" class="menuItem">ğŸ‘¥ ì§ì›ê´€ë¦¬</a>
                <a href="/admin/leave" class="menuItem bossOnly">âš™ï¸ ì—°ì°¨ìŠ¹ì¸</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="mainContent">
            <!-- í—¤ë” -->
            <header class="header">
                <h1>ì—°ì°¨ê´€ë¦¬</h1>
                <div class="userInfo">
                    <a href="/mypage" class="headerUserLink"><span id="userName">ì‚¬ìš©ì</span></a>
                    <button class="btnLogout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ì»¨í…ì¸  -->
            <main class="content">
                <!-- ì—°ì°¨ í˜„í™© -->
                <div class="leaveCard">
                    <h3>ë‚´ ì—°ì°¨ í˜„í™©</h3>
                    <div class="leaveStats">
                        <div class="statBox">
                            <div class="statLabel">ì´ ì—°ì°¨</div>
                            <div class="statValue" id="totalDays">-</div>
                        </div>
                        <div class="statBox">
                            <div class="statLabel">ì‚¬ìš©í•œ ì—°ì°¨</div>
                            <div class="statValue" id="usedDays">-</div>
                        </div>
                        <div class="statBox">
                            <div class="statLabel">ë‚¨ì€ ì—°ì°¨</div>
                            <div class="statValue" id="remainingDays">-</div>
                        </div>
                    </div>
                </div>

                <!-- ì—°ì°¨ ì‹ ì²­ -->
                <div class="leaveCard">
                    <h3>ì—°ì°¨ ì‹ ì²­</h3>
                    <form class="leaveForm" id="leaveForm">
                        <div class="formGroup">
                            <label for="leaveType">ì—°ì°¨ ì¢…ë¥˜</label>
                            <select id="leaveType" name="leaveType" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="annual">ì—°ì°¨</option>
                                <option value="half">ë°˜ì°¨</option>
                                <option value="sick">ë³‘ê°€</option>
                            </select>
                        </div>

                        <div class="dateGroup">
                            <div class="formGroup">
                                <label for="startDate">ì‹œì‘ì¼</label>
                                <input type="date" id="startDate" name="startDate" required>
                            </div>
                            <div class="formGroup">
                                <label for="endDate">ì¢…ë£Œì¼</label>
                                <input type="date" id="endDate" name="endDate" required>
                            </div>
                        </div>

                        <div class="formGroup">
                            <label for="reason">ì‚¬ìœ </label>
                            <textarea id="reason" name="reason" placeholder="ì—°ì°¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                        </div>

                        <button type="submit" class="btnSubmit">ì‹ ì²­í•˜ê¸°</button>
                    </form>
                </div>

                <!-- ì—°ì°¨ ë‚´ì—­ -->
                <div class="leaveHistory">
                    <div class="leaveCard">
                        <h3>ì—°ì°¨ ì‹ ì²­ ë‚´ì—­</h3>
                        <div class="leaveTable">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì‹ ì²­ì¼</th>
                                        <th>ì¢…ë¥˜</th>
                                        <th>ê¸°ê°„</th>
                                        <th>ì¼ìˆ˜</th>
                                        <th>ìƒíƒœ</th>

                                    </tr>
                                </thead>
                                <tbody id="leaveHistoryBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                            ì—°ì°¨ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>

            <!-- í‘¸í„° -->
            <footer class="footer">
                <div class="footerContent">
                    <div>
                        <strong>HR Management System</strong>
                        <p>ì¸ì‚¬ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                    </div>
                </div>
                <div class="copyright">
                    Â© 2024 HR Management System. All rights reserved.
                </div>
            </footer>
        </div>
    </section>

    <script>
        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('memberNo');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');

            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            const userName = localStorage.getItem('userName') || 'í™ê¸¸ë™';
            const userRole = localStorage.getItem('userRole') || 'ROLE_USER';

            document.getElementById('userName').textContent = userName;

            // BOSSì¼ ê²½ìš° ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ
            if (userRole === 'boss' || userRole === 'ROLE_BOSS' || userRole === 'BOSS') {
                document.querySelectorAll('.bossOnly').forEach(item => item.classList.add('show'));
            }

            // ì—°ì°¨ ì •ë³´ ë¡œë“œ
            loadLeaveInfo();
        });

        // ì—°ì°¨ ì •ë³´ ë¡œë“œ
        async function loadLeaveInfo() {
            const memberNo = localStorage.getItem('memberNo');

            if (!memberNo) {
                return;
            }

            try {
                const response = await fetch(`/api/leave/member/${memberNo}`);
                const data = await response.json();

                if (response.ok) {
                    // ì—°ì°¨ í˜„í™© ì—…ë°ì´íŠ¸
                    document.getElementById('totalDays').textContent = data.totalDays + 'ì¼';
                    document.getElementById('usedDays').textContent = data.usedDays + 'ì¼';
                    document.getElementById('remainingDays').textContent = data.remainingDays + 'ì¼';

                    // ì—°ì°¨ ë‚´ì—­ ì—…ë°ì´íŠ¸
                    const tbody = document.getElementById('leaveHistoryBody');
                    if (data.leaveRequests && data.leaveRequests.length > 0) {
                        tbody.innerHTML = data.leaveRequests.map(req => {
                            const statusBadgeClass = req.status === 'pending' ? 'pending' :
                                req.status === 'approved' ? 'approved' : 'rejected';
                            const statusText = req.status === 'pending' ? 'ëŒ€ê¸°' :
                                req.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤';

                            const leaveTypeText = req.leaveType === 'annual' ? 'ì—°ì°¨' :
                                req.leaveType === 'half' ? 'ë°˜ì°¨' : 'ë³‘ê°€';

                            // ëŒ€ê¸° ìƒíƒœì¼ ë•Œë§Œ ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
                            const actionButton = req.status === 'pending' ?
                                `<button class="btnCancel" onclick="cancelLeaveRequest(${req.leaveRequestNo})">ì·¨ì†Œ</button>` :
                                '-';

                            return `
                                <tr>
                                    <td>${new Date(req.requestDate).toLocaleDateString()}</td>
                                    <td>${leaveTypeText}</td>
                                    <td>${req.startDate}${req.startDate !== req.endDate ? ' ~ ' + req.endDate : ''}</td>
                                    <td>${req.days}ì¼</td>
                                    <td><span class="statusBadge ${statusBadgeClass}">${statusText}</span></td>
                                    <td>${actionButton}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #999;">
                                    ì‹ ì²­í•œ ì—°ì°¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const tbody = document.getElementById('leaveHistoryBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #d32f2f;">
                            ì—°ì°¨ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
            }
        }

        // ì—°ì°¨ ì‹ ì²­ ì·¨ì†Œ
        async function cancelLeaveRequest(leaveRequestNo) {
            if (!confirm('íœ´ê°€ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/leave/${leaveRequestNo}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('ì—°ì°¨ ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadLeaveInfo();
                } else {
                    alert(data.message || 'ì—°ì°¨ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì—°ì°¨ ì‹ ì²­ í¼
        document.getElementById('leaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const memberNo = localStorage.getItem('memberNo');

            if (!memberNo) {
                alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/login';
                return;
            }

            const formData = {
                memberNo: memberNo,
                leaveType: document.getElementById('leaveType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                reason: document.getElementById('reason').value
            };

            try {
                const response = await fetch('/api/leave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('ì—°ì°¨ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    e.target.reset();
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëª©ë¡ ê°±ì‹ 
                    window.location.reload();
                } else {
                    alert(data.message || 'ì—°ì°¨ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('Error:', error);
            }
        });
    </script>
</body>

</html>