<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê·¼ í˜„í™© ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/boss-dashboard.css">
</head>

<body>
    <section class="layoutSection">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
        <button class="menuToggle" onclick="toggleSidebar()">â˜°</button>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebarHeader">
                <h2>HR ì‹œìŠ¤í…œ</h2>
            </div>
            <nav class="sidebarMenu">
                <a href="/home" class="menuItem">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="/boss/dashboard" class="menuItem active">ğŸ‘” ì¶œê·¼ í˜„í™©</a>
                <a href="/notice" class="menuItem">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                <a href="/leave" class="menuItem">ğŸ“… ì—°ì°¨ê´€ë¦¬</a>
                <a href="/leaveCalendar" class="menuItem">ğŸ—“ï¸ íœ´ê°€ìº˜ë¦°ë”</a>
                <a href="/attendance" class="menuItem">â° ì¶œí‡´ê·¼</a>
                <a href="/salary" class="menuItem">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</a>
                <a href="/employee" class="menuItem">ğŸ‘¥ ì§ì›ê´€ë¦¬</a>
                <a href="/admin/leave" class="menuItem bossOnly">âš™ï¸ ì—°ì°¨ìŠ¹ì¸</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="mainContent">
            <!-- í—¤ë” -->
            <header class="header">
                <h1>ì¶œê·¼ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
                <div class="userInfo">
                    <a href="/mypage" style="color: #555; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">
                        <span id="userName">ì‚¬ìš©ì</span>
                    </a>
                    <button class="btnLogout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ì»¨í…ì¸  -->
            <main class="content">
                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="dashboardStats" id="dashboardStats">
                    <div class="statCard">
                        <div class="statIcon">ğŸ‘¥</div>
                        <div class="statInfo">
                            <div class="statLabel">ì „ì²´ ì§ì›</div>
                            <div class="statValue" id="totalEmployees">-</div>
                        </div>
                    </div>
                    <div class="statCard attended">
                        <div class="statIcon">âœ…</div>
                        <div class="statInfo">
                            <div class="statLabel">ì¶œê·¼</div>
                            <div class="statValue" id="attendedCount">-</div>
                        </div>
                    </div>
                    <div class="statCard absent">
                        <div class="statIcon">âŒ</div>
                        <div class="statInfo">
                            <div class="statLabel">ë¯¸ì¶œê·¼</div>
                            <div class="statValue" id="absentCount">-</div>
                        </div>
                    </div>
                    <div class="statCard normal">
                        <div class="statIcon">ğŸŸ¢</div>
                        <div class="statInfo">
                            <div class="statLabel">ì •ìƒ ì¶œê·¼</div>
                            <div class="statValue" id="normalCount">-</div>
                        </div>
                    </div>
                    <div class="statCard late">
                        <div class="statIcon">ğŸŸ¡</div>
                        <div class="statInfo">
                            <div class="statLabel">ì§€ê°</div>
                            <div class="statValue" id="lateCount">-</div>
                        </div>
                    </div>
                    <div class="statCard earlyLeave">
                        <div class="statIcon">ğŸŸ </div>
                        <div class="statInfo">
                            <div class="statLabel">ì¡°í‡´</div>
                            <div class="statValue" id="earlyLeaveCount">-</div>
                        </div>
                    </div>
                </div>

                <!-- ë‚ ì§œ í‘œì‹œ -->
                <div class="dateDisplay">
                    <span id="currentDate"></span>
                    <button class="btnRefresh" onclick="loadDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <!-- ì§ì› ëª©ë¡ í…Œì´ë¸” -->
                <div class="dashboardTable">
                    <table>
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ID</th>
                                <th>ì¶œê·¼ ìƒíƒœ</th>
                                <th>ì¶œê·¼ ì‹œê°„</th>
                                <th>í‡´ê·¼ ì‹œê°„</th>
                                <th>ê·¼ë¬´ ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>

            <!-- í‘¸í„° -->
            <footer class="footer">
                <div class="footerContent">
                    <div>
                        <strong>HR Management System</strong>
                        <p>ì¸ì‚¬ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                    </div>
                </div>
                <div class="copyright">
                    Â© 2024 HR Management System. All rights reserved.
                </div>
            </footer>
        </div>
    </section>

    <script>
        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('memberNo');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° í™•ì¸ ë° ê¶Œí•œ ì²´í¬
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const userRole = localStorage.getItem('userRole');

            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            // boss ê¶Œí•œ ì²´í¬
            if (userRole !== 'boss' && userRole !== 'ROLE_BOSS' && userRole !== 'BOSS') {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/home';
                return;
            }

            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const userName = localStorage.getItem('userName');
            if (userName) {
                document.getElementById('userName').textContent = userName;
            }

            // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
            loadDashboard();
        });

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/attendance/dashboard/today', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                
                // ë‚ ì§œ í‘œì‹œ
                document.getElementById('currentDate').textContent = 
                    `${data.date} ì¶œê·¼ í˜„í™©`;

                // í†µê³„ ì—…ë°ì´íŠ¸
                const stats = data.statistics;
                document.getElementById('totalEmployees').textContent = stats.total;
                document.getElementById('attendedCount').textContent = stats.attended;
                document.getElementById('absentCount').textContent = stats.absent;
                document.getElementById('normalCount').textContent = stats.normal;
                document.getElementById('lateCount').textContent = stats.late;
                document.getElementById('earlyLeaveCount').textContent = stats.earlyLeave;

                // ì§ì› ëª©ë¡ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                const tbody = document.getElementById('employeeTableBody');
                tbody.innerHTML = '';

                if (data.employees && data.employees.length > 0) {
                    data.employees.forEach(employee => {
                        const row = document.createElement('tr');
                        
                        // ì¶œê·¼ ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼
                        let statusClass = '';
                        let statusText = '';
                        let statusBadge = '';

                        if (!employee.hasAttended) {
                            statusClass = 'absent';
                            statusText = 'ë¯¸ì¶œê·¼';
                            statusBadge = '<span class="badge absent">ë¯¸ì¶œê·¼</span>';
                        } else {
                            switch(employee.status) {
                                case 'NORMAL':
                                    statusClass = 'normal';
                                    statusText = 'ì •ìƒ';
                                    statusBadge = '<span class="badge normal">ì •ìƒ</span>';
                                    break;
                                case 'LATE':
                                    statusClass = 'late';
                                    statusText = 'ì§€ê°';
                                    statusBadge = '<span class="badge late">ì§€ê°</span>';
                                    break;
                                case 'EARLY_LEAVE':
                                    statusClass = 'earlyLeave';
                                    statusText = 'ì¡°í‡´';
                                    statusBadge = '<span class="badge earlyLeave">ì¡°í‡´</span>';
                                    break;
                                default:
                                    statusClass = '';
                                    statusText = employee.status;
                                    statusBadge = `<span class="badge">${employee.status}</span>`;
                            }
                        }

                        row.className = statusClass;
                        row.innerHTML = `
                            <td>${employee.name || '-'}</td>
                            <td>${employee.id || '-'}</td>
                            <td>${employee.hasAttended ? 'âœ… ì¶œê·¼' : 'âŒ ë¯¸ì¶œê·¼'}</td>
                            <td>${employee.checkInTime || '-'}</td>
                            <td>${employee.checkOutTime || '-'}</td>
                            <td>${employee.workHours || '0:00'}</td>
                            <td>${statusBadge}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('employeeTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: red;">
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
    </script>
</body>

</html>
