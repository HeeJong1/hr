<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œí‡´ê·¼ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/layout.css">
    <style>
        .attendanceSection .contentCard {
            background: white;
            border-radius: clamp(8px, 1vw, 12px);
            padding: clamp(1rem, 3vw, 1.5rem);
            margin-bottom: clamp(1rem, 2vw, 1.5rem);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .attendanceSection .todayCard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: clamp(1.5rem, 4vw, 2.5rem);
        }

        .attendanceSection .todayCard h2 {
            margin: 0 0 clamp(0.5rem, 1vw, 1rem) 0;
            font-size: clamp(1.2rem, 2.5vw, 1.8rem);
        }

        .attendanceSection .currentTime {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: bold;
            margin: clamp(0.5rem, 1vw, 1rem) 0;
        }

        .attendanceSection .currentDate {
            font-size: clamp(1rem, 2vw, 1.2rem);
            opacity: 0.9;
        }

        .attendanceSection .attendanceButtons {
            display: flex;
            gap: clamp(0.8rem, 2vw, 1rem);
            margin-top: clamp(1rem, 2vw, 1.5rem);
            justify-content: center;
            flex-wrap: wrap;
        }

        .attendanceSection .btnAttendance {
            padding: clamp(0.8rem, 2vw, 1rem) clamp(2rem, 4vw, 3rem);
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 600;
            border: none;
            border-radius: clamp(6px, 1vw, 8px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attendanceSection .btnCheckIn {
            background: white;
            color: #667eea;
        }

        .attendanceSection .btnCheckIn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .attendanceSection .btnCheckOut {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .attendanceSection .btnCheckOut:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .attendanceSection .statusBadge {
            display: inline-block;
            padding: clamp(0.3rem, 1vw, 0.4rem) clamp(0.6rem, 2vw, 0.8rem);
            border-radius: clamp(4px, 1vw, 6px);
            font-size: clamp(0.75rem, 1.5vw, 0.85rem);
            font-weight: 600;
        }

        .attendanceSection .statusNormal {
            background: #d4edda;
            color: #155724;
        }

        .attendanceSection .statusLate {
            background: #fff3cd;
            color: #856404;
        }

        .attendanceSection .statusEarlyLeave {
            background: #f8d7da;
            color: #721c24;
        }

        .attendanceSection .statusAbsent {
            background: #f8d7da;
            color: #721c24;
        }

        .attendanceSection .statsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: clamp(0.8rem, 2vw, 1rem);
            margin-bottom: clamp(1rem, 2vw, 1.5rem);
        }

        .attendanceSection .statCard {
            background: white;
            border-radius: clamp(6px, 1vw, 8px);
            padding: clamp(1rem, 2vw, 1.2rem);
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .attendanceSection .statCard h3 {
            margin: 0 0 clamp(0.3rem, 1vw, 0.5rem) 0;
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
            color: #666;
        }

        .attendanceSection .statCard .statValue {
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: bold;
            color: #333;
        }

        .attendanceSection .attendanceTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: clamp(0.8rem, 2vw, 1rem);
        }

        .attendanceSection .attendanceTable th,
        .attendanceSection .attendanceTable td {
            padding: clamp(0.6rem, 2vw, 0.8rem);
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
        }

        .attendanceSection .attendanceTable th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .attendanceSection .attendanceTable tr:hover {
            background: #f8f9fa;
        }

        .attendanceSection .noData {
            text-align: center;
            padding: clamp(2rem, 4vw, 3rem);
            color: #999;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        @media (max-width: 768px) {
            .attendanceSection .attendanceTable {
                font-size: clamp(0.75rem, 2vw, 0.85rem);
            }

            .attendanceSection .attendanceTable th,
            .attendanceSection .attendanceTable td {
                padding: clamp(0.5rem, 1.5vw, 0.6rem);
            }
        }
    </style>
</head>

<body>
    <section class="layoutSection">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
        <button class="menuToggle" onclick="toggleSidebar()">â˜°</button>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebarHeader">
                <h2>HR ì‹œìŠ¤í…œ</h2>
            </div>
            <nav class="sidebarMenu">
                <a href="/home" class="menuItem">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="/notice" class="menuItem">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                <a href="/leave" class="menuItem">ğŸ“… ì—°ì°¨ê´€ë¦¬</a>
                <a href="/leaveCalendar" class="menuItem">ğŸ—“ï¸ íœ´ê°€ìº˜ë¦°ë”</a>
                <a href="/attendance" class="menuItem active">â° ì¶œí‡´ê·¼</a>
                <a href="/salary" class="menuItem">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</a>
                <a href="/employee" class="menuItem">ğŸ‘¥ ì§ì›ê´€ë¦¬</a>
                <a href="/admin/leave" class="menuItem bossOnly">âš™ï¸ ì—°ì°¨ìŠ¹ì¸</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="mainContent">
            <!-- í—¤ë” -->
            <header class="header">
                <h1>ì¶œí‡´ê·¼ ê´€ë¦¬</h1>
                <div class="userInfo">
                    <a href="/mypage" style="color: #555; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">
                        <span id="userName">ì‚¬ìš©ì</span>
                    </a>
                    <button class="btnLogout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ì¶œí‡´ê·¼ ì„¹ì…˜ -->
            <section class="attendanceSection">
                <!-- ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ì¹´ë“œ -->
                <div class="contentCard todayCard">
                    <h2>ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼</h2>
                    <div class="currentDate" id="currentDate">2024ë…„ 1ì›” 20ì¼ í™”ìš”ì¼</div>
                    <div class="currentTime" id="currentTime">00:00:00</div>

                    <div id="todayStatus" style="margin-top: 1rem; font-size: clamp(1rem, 2vw, 1.2rem);">
                        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë‚´ìš© -->
                    </div>

                    <div class="attendanceButtons">
                        <button class="btnAttendance btnCheckIn" onclick="checkIn()">ğŸŒ… ì¶œê·¼í•˜ê¸°</button>
                        <button class="btnAttendance btnCheckOut" onclick="checkOut()">ğŸŒ™ í‡´ê·¼í•˜ê¸°</button>
                    </div>
                </div>

                <!-- ì´ë²ˆ ë‹¬ í†µê³„ -->
                <div class="contentCard">
                    <h2 style="margin: 0 0 clamp(1rem, 2vw, 1.5rem) 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">ì´ë²ˆ ë‹¬ ê·¼ë¬´
                        í†µê³„</h2>
                    <div class="statsGrid">
                        <div class="statCard">
                            <h3>ì´ ê·¼ë¬´ì‹œê°„</h3>
                            <div class="statValue" id="totalHours">0:00</div>
                        </div>
                        <div class="statCard">
                            <h3>í‰ê·  ê·¼ë¬´ì‹œê°„</h3>
                            <div class="statValue" id="avgHours">0:00</div>
                        </div>
                        <div class="statCard">
                            <h3>ì§€ê°</h3>
                            <div class="statValue" id="lateCount">0íšŒ</div>
                        </div>
                        <div class="statCard">
                            <h3>ì¡°í‡´</h3>
                            <div class="statValue" id="earlyLeaveCount">0íšŒ</div>
                        </div>
                    </div>
                </div>

                <!-- ìµœê·¼ ì¶œí‡´ê·¼ ë‚´ì—­ -->
                <div class="contentCard">
                    <h2 style="margin: 0 0 clamp(0.5rem, 1vw, 1rem) 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">ìµœê·¼ ì¶œí‡´ê·¼ ë‚´ì—­
                    </h2>
                    <table class="attendanceTable">
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ì¶œê·¼ì‹œê°„</th>
                                <th>í‡´ê·¼ì‹œê°„</th>
                                <th>ê·¼ë¬´ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="5" class="noData">ì¶œí‡´ê·¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- í‘¸í„° -->
        <footer class="footer">
            <p>&copy; 2024 HR System. All rights reserved.</p>
        </footer>
    </section>

    <script>
        let memberNo = null;
        let userName = null;
        let userRole = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = async function () {
            // ë¡œê·¸ì¸ í™•ì¸
            const token = localStorage.getItem('token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            memberNo = localStorage.getItem('memberNo');
            userName = localStorage.getItem('userName') || 'ì‚¬ìš©ì';
            userRole = localStorage.getItem('userRole');

            document.getElementById('userName').textContent = userName;

            // BOSS ë©”ë‰´ í‘œì‹œ
            if (userRole === 'ROLE_BOSS') {
                document.querySelectorAll('.bossOnly').forEach(item => {
                    item.classList.add('show');
                });
            }

            // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ ì¡°íšŒ
            await loadTodayAttendance();

            // ìµœê·¼ ì¶œí‡´ê·¼ ë‚´ì—­ ì¡°íšŒ
            await loadAttendanceList();

            // ì´ë²ˆ ë‹¬ í†µê³„ ì¡°íšŒ
            await loadMonthlyStats();
        };

        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ ì¡°íšŒ
        async function loadTodayAttendance() {
            try {
                const response = await fetch(`/api/attendance/today/${memberNo}`);
                const data = await response.json();

                const statusDiv = document.getElementById('todayStatus');

                if (data.attendance) {
                    const att = data.attendance;
                    const checkInTime = new Date(att.checkInTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    let statusHtml = `<div>ì¶œê·¼: ${checkInTime}</div>`;

                    if (att.checkOutTime) {
                        const checkOutTime = new Date(att.checkOutTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                        statusHtml += `<div>í‡´ê·¼: ${checkOutTime}</div>`;
                        statusHtml += `<div>ê·¼ë¬´ì‹œê°„: ${att.workHours}</div>`;
                    } else {
                        statusHtml += `<div style="margin-top: 0.5rem; opacity: 0.8;">ê·¼ë¬´ ì¤‘...</div>`;
                    }

                    statusDiv.innerHTML = statusHtml;
                } else {
                    statusDiv.innerHTML = '<div style="opacity: 0.8;">ì•„ì§ ì¶œê·¼í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>';
                }
            } catch (error) {
                console.error('ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ìµœê·¼ ì¶œí‡´ê·¼ ë‚´ì—­ ì¡°íšŒ
        async function loadAttendanceList() {
            try {
                const response = await fetch(`/api/attendance/member/${memberNo}?limit=30`);
                const data = await response.json();

                const tbody = document.getElementById('attendanceTableBody');

                if (!data.attendanceList || data.attendanceList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="noData">ì¶œí‡´ê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                tbody.innerHTML = data.attendanceList.map(att => {
                    const workDate = new Date(att.workDate).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
                    const checkInTime = att.checkInTime ? new Date(att.checkInTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const checkOutTime = att.checkOutTime ? new Date(att.checkOutTime).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '-';
                    const workHours = att.workHours || '-';

                    let statusBadge = '';
                    let statusText = '';

                    switch (att.status) {
                        case 'NORMAL':
                            statusBadge = 'statusNormal';
                            statusText = 'ì •ìƒ';
                            break;
                        case 'LATE':
                            statusBadge = 'statusLate';
                            statusText = 'ì§€ê°';
                            break;
                        case 'EARLY_LEAVE':
                            statusBadge = 'statusEarlyLeave';
                            statusText = 'ì¡°í‡´';
                            break;
                        case 'ABSENT':
                            statusBadge = 'statusAbsent';
                            statusText = 'ê²°ê·¼';
                            break;
                    }

                    return `
                        <tr>
                            <td>${workDate}</td>
                            <td>${checkInTime}</td>
                            <td>${checkOutTime}</td>
                            <td>${workHours}</td>
                            <td><span class="statusBadge ${statusBadge}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('ì¶œí‡´ê·¼ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ë²ˆ ë‹¬ í†µê³„ ì¡°íšŒ
        async function loadMonthlyStats() {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;

                const response = await fetch(`/api/attendance/member/${memberNo}/monthly?year=${year}&month=${month}`);
                const data = await response.json();

                document.getElementById('totalHours').textContent = data.totalHours || '0:00';

                if (data.attendanceList && data.attendanceList.length > 0) {
                    const totalMinutes = data.totalMinutes || 0;
                    const avgMinutes = Math.floor(totalMinutes / data.attendanceList.length);
                    const avgHours = Math.floor(avgMinutes / 60);
                    const avgMins = avgMinutes % 60;
                    document.getElementById('avgHours').textContent = `${avgHours}:${avgMins.toString().padStart(2, '0')}`;

                    const lateCount = data.attendanceList.filter(att => att.status === 'LATE').length;
                    const earlyLeaveCount = data.attendanceList.filter(att => att.status === 'EARLY_LEAVE').length;

                    document.getElementById('lateCount').textContent = `${lateCount}íšŒ`;
                    document.getElementById('earlyLeaveCount').textContent = `${earlyLeaveCount}íšŒ`;
                } else {
                    document.getElementById('avgHours').textContent = '0:00';
                    document.getElementById('lateCount').textContent = '0íšŒ';
                    document.getElementById('earlyLeaveCount').textContent = '0íšŒ';
                }
            } catch (error) {
                console.error('ì›”ë³„ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì¶œê·¼í•˜ê¸°
        async function checkIn() {
            if (!confirm('ì¶œê·¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/api/attendance/check-in', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        memberNo: memberNo,
                        memo: null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    await loadTodayAttendance();
                    await loadAttendanceList();
                    await loadMonthlyStats();
                } else {
                    alert(data.message || 'ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì¶œê·¼ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í‡´ê·¼í•˜ê¸°
        async function checkOut() {
            if (!confirm('í‡´ê·¼ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/api/attendance/check-out', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        memberNo: memberNo
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    await loadTodayAttendance();
                    await loadAttendanceList();
                    await loadMonthlyStats();
                } else {
                    alert(data.message || 'í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í‡´ê·¼ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('memberNo');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            window.location.href = '/login';
        }
    </script>
</body>

</html>