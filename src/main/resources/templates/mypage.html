<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/mypage.css">
</head>

<body>
    <section class="layoutSection">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
        <button class="menuToggle" onclick="toggleSidebar()">â˜°</button>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebarHeader">
                <h2>HR ì‹œìŠ¤í…œ</h2>
            </div>
            <nav class="sidebarMenu">
                <a href="/home" class="menuItem">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="/notice" class="menuItem">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                <a href="/leave" class="menuItem">ğŸ“… ì—°ì°¨ê´€ë¦¬</a>
                <a href="/leaveCalendar" class="menuItem">ğŸ—“ï¸ íœ´ê°€ìº˜ë¦°ë”</a>
                <a href="/attendance" class="menuItem">â° ì¶œí‡´ê·¼</a>
                <a href="/salary" class="menuItem">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</a>
                <a href="/employee" class="menuItem">ğŸ‘¥ ì§ì›ê´€ë¦¬</a>
                <a href="/admin/leave" class="menuItem bossOnly">âš™ï¸ ì—°ì°¨ìŠ¹ì¸</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="mainContent">
            <!-- í—¤ë” -->
            <header class="header">
                <h1>ë§ˆì´í˜ì´ì§€</h1>
                <div class="userInfo">
                    <a href="/mypage" style="color: #555; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">
                        <span id="userName">ì‚¬ìš©ì</span>
                    </a>
                    <button class="btnLogout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ì»¨í…ì¸  -->
            <main class="content">
                <!-- ì—°ì°¨ í˜„í™© -->
                <div class="profileCard">
                    <h3>ë‚´ ì—°ì°¨ í˜„í™©</h3>
                    <div class="profileInfo profileInfoGrid">
                        <div class="infoRow infoRowColumn">
                            <span class="infoLabel">ì´ ì—°ì°¨</span>
                            <span class="infoValue" id="totalDays">-</span>
                        </div>
                        <div class="infoRow infoRowColumn">
                            <span class="infoLabel">ì‚¬ìš©í•œ ì—°ì°¨</span>
                            <span class="infoValue" id="usedDays">-</span>
                        </div>
                        <div class="infoRow infoRowColumn">
                            <span class="infoLabel">ë‚¨ì€ ì—°ì°¨</span>
                            <span class="infoValue" id="remainingDays">-</span>
                        </div>
                    </div>
                </div>

                <!-- í”„ë¡œí•„ ì •ë³´ -->
                <div class="profileCard">
                    <h3>ë‚´ ì •ë³´ <button type="button" id="btnEditProfile" class="btnEditProfile">ìˆ˜ì •</button></h3>
                    <div class="profileInfo">
                        <div class="infoRow">
                            <span class="infoLabel">ì•„ì´ë””</span>
                            <span class="infoValue" id="userId">-</span>
                        </div>
                        <div class="infoRow">
                            <span class="infoLabel">ì´ë¦„</span>
                            <span class="infoValue" id="userNameInfo">-</span>
                        </div>
                        <div class="infoRow">
                            <span class="infoLabel">ì´ë©”ì¼</span>
                            <span class="infoValue" id="userEmail">-</span>
                        </div>
                        <div class="infoRow">
                            <span class="infoLabel">ì—°ë½ì²˜</span>
                            <span class="infoValue" id="userPhone">-</span>
                        </div>
                        <div class="infoRow">
                            <span class="infoLabel">ì§ê¸‰</span>
                            <span class="infoValue" id="userRole">-</span>
                        </div>
                    </div>
                    <div id="profileEditForm" class="profileEditForm">
                        <div class="formGroup">
                            <label>ì´ë¦„</label>
                            <input type="text" id="editName" placeholder="ì´ë¦„">
                        </div>
                        <div class="formGroup">
                            <label>ì—°ë½ì²˜</label>
                            <input type="text" id="editPhone" placeholder="ì—°ë½ì²˜">
                        </div>
                        <button type="button" class="btnSaveProfile">ì €ì¥</button>
                        <button type="button" class="btnCancelProfile">ì·¨ì†Œ</button>
                    </div>
                </div>
                <div class="profileCard">
                    <h3>ë°”ë¡œê°€ê¸°</h3>
                    <div class="quickLinks">
                        <a href="/attendance/statistics">ë‚´ ì¶œê·¼ ê¸°ë¡/í†µê³„</a>
                        <a href="/salary/statement">ë‚´ ì›”ê¸‰ ë‚´ì—­ì„œ</a>
                    </div>
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
                <div class="profileCard">
                    <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                    <div id="message" class="message"></div>
                    <form id="passwordChangeForm" class="passwordChange">
                        <div class="formGroup">
                            <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="currentPassword" required placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="formGroup">
                            <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="newPassword" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="formGroup">
                            <label for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirmPassword" required placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <button type="submit" class="btnChangePassword">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </main>

            <!-- í‘¸í„° -->
            <footer class="footer">
                <div class="footerContent">
                    <div>
                        <strong>HR Management System</strong>
                        <p>ì¸ì‚¬ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                    </div>
                </div>
                <div class="copyright">
                    Â© 2024 HR Management System. All rights reserved.
                </div>
            </footer>
        </div>
    </section>

    <script>
        // ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('memberNo');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');

            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userId = localStorage.getItem('userId') || '-';
            const userEmail = localStorage.getItem('userEmail') || '-';
            const userName = localStorage.getItem('userName') || 'ì‚¬ìš©ì';
            const userRole = localStorage.getItem('userRole') || 'ROLE_USER';
            const memberNo = localStorage.getItem('memberNo');

            document.getElementById('userName').textContent = userName;
            document.getElementById('userNameInfo').textContent = userName;
            document.getElementById('userId').textContent = userId;
            document.getElementById('userEmail').textContent = userEmail;

            if (memberNo) {
                fetch(`/api/members/${memberNo}/profile`)
                    .then(r => r.json())
                    .then(profile => {
                        if (profile.name) document.getElementById('userNameInfo').textContent = profile.name;
                        if (profile.phone !== undefined) document.getElementById('userPhone').textContent = profile.phone || '-';
                        document.getElementById('editName').value = profile.name || '';
                        document.getElementById('editPhone').value = profile.phone || '';
                    })
                    .catch(() => { document.getElementById('userPhone').textContent = '-'; });
            } else {
                document.getElementById('userPhone').textContent = '-';
            }

            // ì§ê¸‰ í‘œì‹œ
            let roleText = 'USER';
            if (userRole === 'boss' || userRole === 'ROLE_BOSS' || userRole === 'BOSS') {
                roleText = 'BOSS';
                document.querySelectorAll('.bossOnly').forEach(item => item.classList.add('show'));
            }
            document.getElementById('userRole').textContent = roleText;

            // ì—°ì°¨ ì •ë³´ ë¡œë“œ
            if (memberNo) {
                await loadLeaveInfo(memberNo);
            }
        });

        // ì—°ì°¨ ì •ë³´ ë¡œë“œ
        async function loadLeaveInfo(memberNo) {
            try {
                const response = await fetch(`/api/leave/member/${memberNo}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('totalDays').textContent = data.totalDays + 'ì¼';
                    document.getElementById('usedDays').textContent = data.usedDays + 'ì¼';
                    document.getElementById('remainingDays').textContent = data.remainingDays + 'ì¼';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // í”„ë¡œí•„ ìˆ˜ì • í† ê¸€
        document.getElementById('btnEditProfile').addEventListener('click', () => {
            document.getElementById('profileEditForm').style.display = document.getElementById('profileEditForm').style.display === 'none' ? 'block' : 'none';
        });
        document.querySelector('.btnCancelProfile').addEventListener('click', () => {
            document.getElementById('profileEditForm').style.display = 'none';
        });
        document.querySelector('.btnSaveProfile').addEventListener('click', async () => {
            const memberNo = localStorage.getItem('memberNo');
            if (!memberNo) return;
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            try {
                const res = await fetch(`/api/members/${memberNo}/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone })
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    document.getElementById('userNameInfo').textContent = name || document.getElementById('userNameInfo').textContent;
                    document.getElementById('userPhone').textContent = phone || '-';
                    document.getElementById('profileEditForm').style.display = 'none';
                    localStorage.setItem('userName', name || localStorage.getItem('userName'));
                } else {
                    showMessage(data.message || 'ìˆ˜ì • ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                showMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼
        document.getElementById('passwordChangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const memberNo = localStorage.getItem('memberNo');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showMessage('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!memberNo) {
                showMessage('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/members/${memberNo}/password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showMessage(data.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error('Error:', error);
            }
        });
    </script>
</body>

</html>