<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/salary.css">
</head>

<body>
    <section class="layoutSection">
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
        <button class="menuToggle" onclick="toggleSidebar()">â˜°</button>

        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebarHeader">
                <h2>HR ì‹œìŠ¤í…œ</h2>
            </div>
            <nav class="sidebarMenu">
                <a href="/home" class="menuItem">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="/boss/dashboard" class="menuItem bossOnly">ğŸ‘” ì¶œê·¼ í˜„í™©</a>
                <a href="/attendance/statistics" class="menuItem">ğŸ“ˆ ì¶œê·¼ í†µê³„</a>
                <a href="/notice" class="menuItem">ğŸ“¢ ê³µì§€ì‚¬í•­</a>
                <a href="/leave" class="menuItem">ğŸ“… ì—°ì°¨ê´€ë¦¬</a>
                <a href="/leaveCalendar" class="menuItem">ğŸ—“ï¸ íœ´ê°€ìº˜ë¦°ë”</a>
                <a href="/attendance" class="menuItem">â° ì¶œí‡´ê·¼</a>
                <a href="/salary" class="menuItem active">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</a>
                <a href="/salary/statement" class="menuItem">ğŸ’µ ì›”ê¸‰ ë‚´ì—­ì„œ</a>
                <a href="/employee" class="menuItem">ğŸ‘¥ ì§ì›ê´€ë¦¬</a>
                <a href="/admin/leave" class="menuItem bossOnly">âš™ï¸ ì—°ì°¨ìŠ¹ì¸</a>
            </nav>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="mainContent">
            <!-- í—¤ë” -->
            <header class="header">
                <h1>ê¸‰ì—¬ ê´€ë¦¬</h1>
                <div class="userInfo">
                    <a href="/mypage" style="color: #555; text-decoration: none; font-size: clamp(0.9rem, 2vw, 1rem);">
                        <span id="userName">ì‚¬ìš©ì</span>
                    </a>
                    <button class="btnLogout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </header>

            <!-- ê¸‰ì—¬ ì„¹ì…˜ -->
            <section class="salarySection">
                <!-- í˜„ì¬ ê¸‰ì—¬ ì •ë³´ -->
                <div class="contentCard salaryInfoCard" id="salaryInfoCard" style="display: none;">
                    <h2>ë‚´ ê¸‰ì—¬ ì •ë³´</h2>
                    <div class="salaryGrid">
                        <div class="salaryItem">
                            <label>ê¸°ë³¸ê¸‰</label>
                            <div class="value" id="baseSalary">0ì›</div>
                        </div>
                        <div class="salaryItem">
                            <label>ì§ì±…ìˆ˜ë‹¹</label>
                            <div class="value" id="positionAllowance">0ì›</div>
                        </div>
                        <div class="salaryItem">
                            <label>ì‹ëŒ€</label>
                            <div class="value" id="mealAllowance">0ì›</div>
                        </div>
                        <div class="salaryItem">
                            <label>êµí†µë¹„</label>
                            <div class="value" id="transportAllowance">0ì›</div>
                        </div>
                    </div>
                </div>

                <!-- ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­ -->
                <div class="contentCard">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: clamp(1rem, 2vw, 1.5rem);">
                        <h2 style="margin: 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­</h2>
                    </div>
                    <table class="paymentHistoryTable">
                        <thead>
                            <tr>
                                <th>ì§€ê¸‰ë…„ì›”</th>
                                <th>ì´ ì§€ê¸‰ì•¡</th>
                                <th>ê³µì œì•¡</th>
                                <th>ì‹¤ ì§€ê¸‰ì•¡</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody">
                            <tr>
                                <td colspan="5" class="noData">ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- í‘¸í„° -->
        <footer class="footer">
            <p>&copy; 2024 HR System. All rights reserved.</p>
        </footer>
    </section>

    <!-- ê¸‰ì—¬ ëª…ì„¸ì„œ ëª¨ë‹¬ -->
    <div id="salaryDetailModal" class="modal">
        <div class="modalContent">
            <div class="modalHeader">
                <h2>ê¸‰ì—¬ ëª…ì„¸ì„œ</h2>
                <button class="closeModal" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="salaryDetailContent">
                <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë‚´ìš© -->
            </div>
        </div>
    </div>

    <script>
        let memberNo = null;
        let userName = null;
        let userRole = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = async function () {
            // ë¡œê·¸ì¸ í™•ì¸
            const token = localStorage.getItem('token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            memberNo = localStorage.getItem('memberNo');
            userName = localStorage.getItem('userName') || 'ì‚¬ìš©ì';
            userRole = localStorage.getItem('userRole');

            document.getElementById('userName').textContent = userName;

            // BOSS ë©”ë‰´ í‘œì‹œ
            if (userRole === 'boss' || userRole === 'ROLE_BOSS' || userRole === 'BOSS') {
                document.querySelectorAll('.bossOnly').forEach(item => {
                    item.classList.add('show');
                });
            }

            // ê¸‰ì—¬ ì •ë³´ ë° ë‚´ì—­ ì¡°íšŒ
            await loadSalaryInfo();
            await loadPaymentHistory();
        };

        // ê¸‰ì—¬ ì •ë³´ ì¡°íšŒ
        async function loadSalaryInfo() {
            try {
                const response = await fetch(`/api/salary/member/${memberNo}`);
                const data = await response.json();

                if (data.salary) {
                    const salary = data.salary;
                    document.getElementById('salaryInfoCard').style.display = 'block';
                    document.getElementById('baseSalary').textContent = formatCurrency(salary.baseSalary);
                    document.getElementById('positionAllowance').textContent = formatCurrency(salary.positionAllowance);
                    document.getElementById('mealAllowance').textContent = formatCurrency(salary.mealAllowance);
                    document.getElementById('transportAllowance').textContent = formatCurrency(salary.transportAllowance);
                }
            } catch (error) {
                console.error('ê¸‰ì—¬ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­ ì¡°íšŒ
        async function loadPaymentHistory() {
            try {
                const response = await fetch(`/api/salary/payment/member/${memberNo}`);
                const data = await response.json();

                const tbody = document.getElementById('paymentTableBody');

                if (!data.payments || data.payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="noData">ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                tbody.innerHTML = data.payments.map(payment => {
                    const statusClass = payment.status === 'PAID' ? 'statusPaid' : 'statusPending';
                    const statusText = payment.status === 'PAID' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘';

                    return `
                        <tr onclick="showPaymentDetail(${payment.salaryPaymentNo})">
                            <td>${payment.paymentYear}ë…„ ${payment.paymentMonth}ì›”</td>
                            <td>${formatCurrency(payment.totalAmount)}</td>
                            <td>${formatCurrency(payment.totalDeduction)}</td>
                            <td><strong>${formatCurrency(payment.netAmount)}</strong></td>
                            <td><span class="statusBadge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ê¸‰ì—¬ ëª…ì„¸ì„œ ìƒì„¸ë³´ê¸°
        async function showPaymentDetail(salaryPaymentNo) {
            try {
                const response = await fetch(`/api/salary/payment/${salaryPaymentNo}`);
                const data = await response.json();

                if (data.payment) {
                    const p = data.payment;
                    const content = `
                        <div style="margin-bottom: 1rem;">
                            <h3 style="color: #667eea; margin: 0 0 0.5rem 0;">${p.paymentYear}ë…„ ${p.paymentMonth}ì›” ê¸‰ì—¬ ëª…ì„¸ì„œ</h3>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">ì§€ê¸‰ì¼: ${formatDate(p.paymentDate)}</p>
                        </div>

                        <div class="salaryDetailGrid">
                            <div class="salaryDetailItem">
                                <label>ê¸°ë³¸ê¸‰</label>
                                <div class="value">${formatCurrency(p.baseSalary)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ì§ì±…ìˆ˜ë‹¹</label>
                                <div class="value">${formatCurrency(p.positionAllowance)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ì‹ëŒ€</label>
                                <div class="value">${formatCurrency(p.mealAllowance)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>êµí†µë¹„</label>
                                <div class="value">${formatCurrency(p.transportAllowance)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ì´ˆê³¼ê·¼ë¬´ìˆ˜ë‹¹</label>
                                <div class="value">${formatCurrency(p.overtimePay)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ìƒì—¬ê¸ˆ</label>
                                <div class="value">${formatCurrency(p.bonus)}</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ê·¼ë¬´ì¼ìˆ˜</label>
                                <div class="value">${p.workDays || 0}ì¼</div>
                            </div>
                            <div class="salaryDetailItem">
                                <label>ê·¼ë¬´ì‹œê°„</label>
                                <div class="value">${p.workHours || 0}ì‹œê°„</div>
                            </div>
                        </div>

                        <div class="salaryTotal">
                            <div class="totalItem">
                                <span>ì´ ì§€ê¸‰ì•¡</span>
                                <strong>${formatCurrency(p.totalAmount)}</strong>
                            </div>
                            <div class="totalItem">
                                <span>ì†Œë“ì„¸</span>
                                <span style="color: #d32f2f;">-${formatCurrency(p.incomeTax)}</span>
                            </div>
                            <div class="totalItem">
                                <span>êµ­ë¯¼ì—°ê¸ˆ</span>
                                <span style="color: #d32f2f;">-${formatCurrency(p.nationalPension)}</span>
                            </div>
                            <div class="totalItem">
                                <span>ê±´ê°•ë³´í—˜</span>
                                <span style="color: #d32f2f;">-${formatCurrency(p.healthInsurance)}</span>
                            </div>
                            <div class="totalItem">
                                <span>ê³ ìš©ë³´í—˜</span>
                                <span style="color: #d32f2f;">-${formatCurrency(p.employmentInsurance)}</span>
                            </div>
                            <div class="totalItem final">
                                <span>ì‹¤ ì§€ê¸‰ì•¡</span>
                                <span>${formatCurrency(p.netAmount)}</span>
                            </div>
                        </div>
                    `;

                    document.getElementById('salaryDetailContent').innerHTML = content;
                    document.getElementById('salaryDetailModal').style.display = 'block';
                }
            } catch (error) {
                console.error('ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('salaryDetailModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const modal = document.getElementById('salaryDetailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // ê¸ˆì•¡ í¬ë§·
        function formatCurrency(amount) {
            if (!amount) return '0ì›';
            return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('memberNo');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            window.location.href = '/login';
        }
    </script>
</body>

</html>