<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heejong.hr.mapper.LeaveRequestMapper">

    <!-- Result Map -->
    <resultMap id="leaveRequestResultMap" type="com.heejong.hr.entity.LeaveRequest">
        <id property="leaveRequestNo" column="leave_request_no"/>
        <result property="memberNo" column="member_no"/>
        <result property="leaveType" column="leave_type"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="days" column="days"/>
        <result property="reason" column="reason"/>
        <result property="status" column="status"/>
        <result property="requestDate" column="request_date"/>
        <result property="approvedDate" column="approved_date"/>
        <result property="approverComment" column="approver_comment"/>
        <result property="memberId" column="member_id"/>
        <result property="memberName" column="member_name"/>
    </resultMap>

    <!-- 연차 신청 -->
    <insert id="insertLeaveRequest" parameterType="com.heejong.hr.entity.LeaveRequest">
        INSERT INTO leave_request (
            member_no, leave_type, start_date, end_date, days, reason, status
        ) VALUES (
            #{memberNo}, #{leaveType}, #{startDate}, #{endDate}, #{days}, #{reason}, 'pending'
        )
    </insert>

    <!-- 특정 회원의 연차 신청 목록 조회 -->
    <select id="findByMemberNo" parameterType="long" resultMap="leaveRequestResultMap">
        SELECT 
            lr.leave_request_no,
            lr.member_no,
            lr.leave_type,
            lr.start_date,
            lr.end_date,
            lr.days,
            lr.reason,
            lr.status,
            lr.request_date,
            lr.approved_date,
            lr.approver_comment,
            m.id as member_id,
            m.name as member_name
        FROM leave_request lr
        INNER JOIN member m ON lr.member_no = m.member_no
        WHERE lr.member_no = #{memberNo}
        ORDER BY lr.request_date DESC
    </select>

    <!-- 모든 연차 신청 목록 조회 (관리자용) -->
    <select id="findAll" resultMap="leaveRequestResultMap">
        SELECT 
            lr.leave_request_no,
            lr.member_no,
            lr.leave_type,
            lr.start_date,
            lr.end_date,
            lr.days,
            lr.reason,
            lr.status,
            lr.request_date,
            lr.approved_date,
            lr.approver_comment,
            m.id as member_id,
            m.name as member_name
        FROM leave_request lr
        INNER JOIN member m ON lr.member_no = m.member_no
        ORDER BY lr.request_date DESC
    </select>

    <!-- 연차 신청 상세 조회 -->
    <select id="findByLeaveRequestNo" parameterType="long" resultMap="leaveRequestResultMap">
        SELECT 
            lr.leave_request_no,
            lr.member_no,
            lr.leave_type,
            lr.start_date,
            lr.end_date,
            lr.days,
            lr.reason,
            lr.status,
            lr.request_date,
            lr.approved_date,
            lr.approver_comment,
            m.id as member_id,
            m.name as member_name
        FROM leave_request lr
        INNER JOIN member m ON lr.member_no = m.member_no
        WHERE lr.leave_request_no = #{leaveRequestNo}
    </select>

    <!-- 연차 신청 상태 변경 (승인/반려) -->
    <update id="updateStatus" parameterType="com.heejong.hr.entity.LeaveRequest">
        UPDATE leave_request
        SET 
            status = #{status},
            approved_date = #{approvedDate},
            approver_comment = #{approverComment}
        WHERE leave_request_no = #{leaveRequestNo}
    </update>

    <!-- 연차 신청 삭제 -->
    <delete id="deleteLeaveRequest" parameterType="long">
        DELETE FROM leave_request
        WHERE leave_request_no = #{leaveRequestNo}
    </delete>

    <!-- 특정 회원의 승인된 연차 일수 합계 -->
    <select id="getTotalUsedDays" parameterType="long" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(days), 0)
        FROM leave_request
        WHERE member_no = #{memberNo}
        AND status = 'approved'
    </select>

    <!-- 날짜 범위로 승인된 연차 조회 (캘린더용) -->
    <select id="findByDateRange" resultMap="leaveRequestResultMap">
        SELECT 
            lr.leave_request_no,
            lr.member_no,
            lr.leave_type,
            lr.start_date,
            lr.end_date,
            lr.days,
            lr.reason,
            lr.status,
            lr.request_date,
            lr.approved_date,
            lr.approver_comment,
            m.id as member_id,
            m.name as member_name
        FROM leave_request lr
        INNER JOIN member m ON lr.member_no = m.member_no
        WHERE lr.status = 'approved'
        AND (
            (lr.start_date BETWEEN #{startDate} AND #{endDate})
            OR (lr.end_date BETWEEN #{startDate} AND #{endDate})
            OR (lr.start_date &lt;= #{startDate} AND lr.end_date &gt;= #{endDate})
        )
        ORDER BY lr.start_date ASC
    </select>

</mapper>
