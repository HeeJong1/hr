<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heejong.hr.mapper.AttendanceMapper">

    <resultMap id="attendanceResultMap" type="com.heejong.hr.entity.Attendance">
        <id property="attendanceNo" column="attendance_no"/>
        <result property="memberNo" column="member_no"/>
        <result property="workDate" column="work_date"/>
        <result property="checkInTime" column="check_in_time"/>
        <result property="checkOutTime" column="check_out_time"/>
        <result property="status" column="status"/>
        <result property="workMinutes" column="work_minutes"/>
        <result property="memo" column="memo"/>
        <result property="memberId" column="member_id"/>
        <result property="memberName" column="member_name"/>
    </resultMap>

    <!-- 출근 등록 -->
    <insert id="insertCheckIn" parameterType="com.heejong.hr.entity.Attendance">
        INSERT INTO attendance (member_no, work_date, check_in_time, status, memo)
        VALUES (#{memberNo}, #{workDate}, #{checkInTime}, #{status}, #{memo})
    </insert>

    <!-- 퇴근 등록 -->
    <update id="updateCheckOut" parameterType="com.heejong.hr.entity.Attendance">
        UPDATE attendance
        SET check_out_time = #{checkOutTime},
            work_minutes = #{workMinutes},
            status = #{status}
        WHERE attendance_no = #{attendanceNo}
    </update>

    <!-- 특정 회원의 특정 날짜 출퇴근 기록 조회 -->
    <select id="findByMemberNoAndDate" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        WHERE a.member_no = #{memberNo} AND a.work_date = #{workDate}
    </select>

    <!-- 특정 회원의 출퇴근 기록 목록 조회 -->
    <select id="findByMemberNo" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        WHERE a.member_no = #{memberNo}
        ORDER BY a.work_date DESC, a.check_in_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 특정 회원의 월별 출퇴근 기록 조회 -->
    <select id="findByMemberNoAndMonth" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        WHERE a.member_no = #{memberNo}
          AND EXTRACT(YEAR FROM a.work_date) = #{year}
          AND EXTRACT(MONTH FROM a.work_date) = #{month}
        ORDER BY a.work_date DESC
    </select>

    <!-- 모든 출퇴근 기록 조회 -->
    <select id="findAll" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        ORDER BY a.work_date DESC, a.check_in_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 특정 날짜의 모든 출퇴근 기록 조회 -->
    <select id="findByDate" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        WHERE a.work_date = #{workDate}
        ORDER BY a.check_in_time DESC
    </select>

    <!-- 특정 회원의 월별 총 근무시간 조회 -->
    <select id="getTotalWorkMinutes" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(work_minutes), 0)
        FROM attendance
        WHERE member_no = #{memberNo}
          AND EXTRACT(YEAR FROM work_date) = #{year}
          AND EXTRACT(MONTH FROM work_date) = #{month}
    </select>

    <!-- 출퇴근 기록 삭제 -->
    <delete id="deleteAttendance">
        DELETE FROM attendance
        WHERE attendance_no = #{attendanceNo}
    </delete>

    <!-- 특정 회원의 월별 출근 통계 조회 -->
    <select id="getMonthlyStatistics" resultType="java.util.HashMap">
        SELECT 
            COUNT(*) as "totalDays",
            COUNT(CASE WHEN status = 'NORMAL' THEN 1 END) as "normalDays",
            COUNT(CASE WHEN status = 'LATE' THEN 1 END) as "lateDays",
            COUNT(CASE WHEN status = 'EARLY_LEAVE' THEN 1 END) as "earlyLeaveDays",
            COUNT(CASE WHEN status = 'ABSENT' THEN 1 END) as "absentDays",
            COALESCE(SUM(work_minutes), 0) as "totalWorkMinutes"
        FROM attendance
        WHERE member_no = #{memberNo}
          AND EXTRACT(YEAR FROM work_date) = #{year}
          AND EXTRACT(MONTH FROM work_date) = #{month}
    </select>

    <!-- 특정 회원의 연도별 출근 통계 조회 -->
    <select id="getYearlyStatistics" resultType="java.util.HashMap">
        SELECT 
            COUNT(*) as "totalDays",
            COUNT(CASE WHEN status = 'NORMAL' THEN 1 END) as "normalDays",
            COUNT(CASE WHEN status = 'LATE' THEN 1 END) as "lateDays",
            COUNT(CASE WHEN status = 'EARLY_LEAVE' THEN 1 END) as "earlyLeaveDays",
            COUNT(CASE WHEN status = 'ABSENT' THEN 1 END) as "absentDays",
            COALESCE(SUM(work_minutes), 0) as "totalWorkMinutes"
        FROM attendance
        WHERE member_no = #{memberNo}
          AND EXTRACT(YEAR FROM work_date) = #{year}
    </select>

    <!-- 특정 기간의 모든 직원 출근 기록 조회 -->
    <select id="findByDateRange" resultMap="attendanceResultMap">
        SELECT a.attendance_no, a.member_no, a.work_date, a.check_in_time, a.check_out_time,
               a.status, a.work_minutes, a.memo,
               m.id as member_id, m.name as member_name
        FROM attendance a
        LEFT JOIN member m ON a.member_no = m.member_no
        WHERE a.work_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY a.work_date DESC, a.check_in_time DESC
    </select>

</mapper>
